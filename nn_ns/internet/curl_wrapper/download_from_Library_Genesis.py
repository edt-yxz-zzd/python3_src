

r'''

download from Library Genesis
http://libgen.io/

http://libgen.io/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40
http://93.174.95.27/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40
http://93.174.95.27/ads.php?md5=8BDDD46CC786476D4B7A0DD942E20D40


<td align='center' rowspan=2 valign='top'>
    <a href='/get.php?md5=8BDDD46CC786476D4B7A0DD942E20D40&key=A4ZZGLC5UWTVM7VV'><h2>DOWNLOAD</h2></a></br>
    <a href='/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40&oftorrent='>Download via torrent </a>
    <input id="textarea-example" value="(Applied Logic Series 29) Fairouz Kamareddine, Twan Laan, Rob Nederpelt-A Modern Perspective on Type Theory_ From its Origins until Today-Springer (2005).pdf" type="text" size="9">
    <button class="btn-clipboard" data-clipboard-target="#textarea-example"> (need rename file)</button>
    <script>new Clipboard(".btn-clipboard");</script></br>
    <textarea rows='13' name='bibtext' id='bibtext' readonly cols='40'>
        @book
        {
            book:535656,
            title =     {A Modern Perspective on Type Theory: From its Origins until Today},
            author =    {Fairouz Kamareddine, Twan Laan, Rob Nederpelt},
            publisher = {Springer},
            isbn =      {1402023359,9781402023354,1402023340,9781402023347},
            year =      {2005},
            series =    {Applied Logic Series 29},
            edition =   {},
            volume =    {},
            url =       {http://gen.lib.rus.ec/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40}
        }
   </textarea><br>
   <img src='https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=http%3A%2F%2Fgen.lib.rus.ec%2Fbook%2Findex.php%3Fmd5%3D8BDDD46CC786476D4B7A0DD942E20D40&choe=UTF-8' title='Link to Libgen' />
</td>

'''

download_page = rb'''
<!doctype html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Library Genesis</title>

<style>
#message {
	width: 400px;
	margin: 0px auto;
	padding: 10px 20px;
	text-align: center;	
	background-color: #0f9d58;
	color: #fff;
	border-radius: 3px;
}
</style>
<script src="/jquery-latest.min.js"></script>
<script src="/clipboard.min.js"></script>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><script>
$(document).ready(function() {
	function appendMessage(argument) {
		var div = $('<div>').attr('id', 'message').text('Ad block is installed and active. Please support us by disabling it.');
		var add = $('table').before(div);
	}
	setTimeout(function(){
		if($("ins").css('display') == "none") {
			appendMessage();
		}
	}, 500);
});
</script><table width=1000 align="center" border=0>
<tr>
<td align="left" valign="top" rowspan=2><font size=2 color="grey">Advertising:</font><br><div id="ads17">
<!-- gen_sky_160x600_1 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1513624324396300"
     data-ad-slot="1943478249"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></td>
<td rowspan=2 valign="top"><font size=2 color="grey">BitCoin: <a href="bitcoin:1Gz3SZniRo8isQzgPiuovr11n3s75zecg2?label=libgen">1Gz3SZniRo8isQzgPiuovr11n3s75zecg2</a></font><br><div id="ads8">
<!-- gen_sky1 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-1513624324396300"
     data-ad-slot="7992188641"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></td>
<td align='center' rowspan=2 valign='top'><a href='/get.php?md5=8BDDD46CC786476D4B7A0DD942E20D40&key=XPCJ7VW7DJ5NP389'><h2>DOWNLOAD</h2></a></br><a href='/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40&oftorrent='>Download via torrent </a><input id="textarea-example" value="(Applied Logic Series 29) Fairouz Kamareddine, Twan Laan, Rob Nederpelt-A Modern Perspective on Type Theory_ From its Origins until Today-Springer (2005).pdf" type="text" size="9"><button class="btn-clipboard" data-clipboard-target="#textarea-example"> (need rename file)</button><script>new Clipboard(".btn-clipboard");</script></br><textarea rows='13' name='bibtext' id='bibtext' readonly cols='40'>@book{book:535656,
   title =     {A Modern Perspective on Type Theory: From its Origins until Today},
   author =    {Fairouz Kamareddine, Twan Laan, Rob Nederpelt},
   publisher = {Springer},
   isbn =      {1402023359,9781402023354,1402023340,9781402023347},
   year =      {2005},
   series =    {Applied Logic Series 29},
   edition =   {},
   volume =    {},
   url =       {http://gen.lib.rus.ec/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40}}</textarea>
<br><img src='https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=http%3A%2F%2Fgen.lib.rus.ec%2Fbook%2Findex.php%3Fmd5%3D8BDDD46CC786476D4B7A0DD942E20D40&choe=UTF-8' title='Link to Libgen' /></td>
<td align="left" valign="top" rowspan=2><div id="ads18">
<!-- gen_sky_160x600_2 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-1513624324396300"
     data-ad-slot="4896944640"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div></td>
</tr>
</table></body></html>
'''



import bs4
from bs4 import BeautifulSoup
import re
import os.path
from urllib.parse import urlparse, urlunparse, parse_qs
#import urllib2
import urllib.request
import bibtexparser
from bibtexparser import bparser
#response = urllib2.urlopen('http://python.org/')
#html = response.read()
def fetch(url, *, timeout=None):
    response = urllib.request.urlopen(url, timeout=timeout)
    html = response.read() # bytes
    return html
    with open('url.bytes', 'xb') as fout:
        fout.write(html)
    print(type(html), len(html))
    return html


no_root_download_url_rex = re.compile(r'(?i)^/get\.php\?md5=(?P<md5>[0-9a-fA-F]{32})&key=(?P<key>\w*)$')
def parse_download_page(html):
    p = BeautifulSoup(html, 'lxml')
    return parse_download_page__bs4(p)
    try:
        return parse_download_page__bs4(p)
    except:
        print(html)
        raise
def parse_download_page__bs4(soup):
    p = soup
    bibtext_node = p.find( 'textarea'
                         , id='bibtext'
                         , attrs={'name':'bibtext'}
                         )
    if bibtext_node is None:
        raise Exception('not download_page or this function out-of-date')
    bibtext = bibtext_node.string
    bibtext = str(bibtext)


    #rint(bibtext_node.parent.name)
    #rint(bibtext_node.parent.prettify())
    it = bibtext_node.parent.find_all('a', href=True, recursive=False)
    it = iter(it)
    for download_url_node in it:
        break
    else:
        raise Exception('No download_url_node on download_page')
    for torrent_url_node in it:
        break
    else:
        torrent_url_node = None # may not exist
    assert download_url_node.string.strip().upper() == 'DOWNLOAD'
    no_root_download_url = download_url_node['href']
    no_root_torrent_url = torrent_url_node['href'] \
            if torrent_url_node else None
    m = no_root_download_url_rex.match(no_root_download_url)
    if not m:
        raise Exception('not a Library Genesis download page or this function out of date')
    # assert no_root_torrent_url.startswith()
    md5, key = m.group('md5', 'key')

    fname = p.find('input', id="textarea-example")['value'] \
            if torrent_url_node else '<unknown>'
    return bibtext, no_root_download_url, no_root_torrent_url, md5, key, fname

def bibtext2std_name(bibtext):
    bp = bparser.BibTexParser()
    db = bp.parse(bibtext)
    #rint(r)
    #help(r)
    d = db.get_entry_dict()
    (_, d), = d.items()
    #rint(d)
    title = d['title']
    author = d['author']
    year = d['year']
    edition = d['edition']
    volume = d['volume']
    def strip(s):
        return s.strip()
    def f_title(title):
        title = title.strip()
        return ' -- '.join(map(strip, title.split(':')))
    def f(s, suffix=''):
        s = s.strip()
        return '('+s+suffix+')' if s else ''
    return '{title} {volume}{edition}{year}{author}'.format(
        title = f_title(title),
        volume = f(volume),
        edition = f(edition, 'ed'),
        year = f(year),
        author = f(author)
        )
    return title+edition+year+authors
bibtext = r'''
        @book
        {
            book:535656,
            title =     {A Modern Perspective on Type Theory: From its Origins until Today},
            author =    {Fairouz Kamareddine, Twan Laan, Rob Nederpelt},
            publisher = {Springer},
            isbn =      {1402023359,9781402023354,1402023340,9781402023347},
            year =      {2005},
            series =    {Applied Logic Series 29},
            edition =   {},
            volume =    {},
            url =       {http://gen.lib.rus.ec/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40}
        }
'''
#rint(bibtext2std_name(bibtext))



def fetch_info_from_download_page_url(download_page_url, *, timeout=None):
    html = fetch(download_page_url, timeout=timeout)
    std_fname, no_root_download_url, no_root_torrent_url, md5, key =\
        fetch_info_from_download_page(html)

    root = get_root_from_url(download_page_url)
    download_url = root + no_root_download_url
    torrent_url = root + no_root_torrent_url if no_root_torrent_url else None
    return std_fname, download_url, torrent_url, md5, key

def fetch_info_from_download_page(download_page):
    html = download_page
    bibtext, no_root_download_url, no_root_torrent_url, md5, key, fname = \
        parse_download_page(html)
    #rint(type(bibtext), bibtext)
    _, fname_ext = os.path.splitext(fname)
    std_name = bibtext2std_name(bibtext)
    std_fname = std_name + fname_ext
    return std_fname, no_root_download_url, no_root_torrent_url, md5, key

def get_one_md5_from_url(url):
    return get_md5s_from_url(url)[0]
def get_md5s_from_url(url):
    _, query = get_value_from_url(url)
    return query['md5']
def get_value_from_url(url):
    p = urlparse(url)
    query = parse_qs(p.query)
    return p, query
    ParseResult ( scheme='http'
                , netloc='93.174.95.27'
                , path='/book/index.php'
                , params=''
                , query='md5=8BDDD46CC786476D4B7A0DD942E20D40'
                , fragment=''
                )
    {'md5': ['8BDDD46CC786476D4B7A0DD942E20D40']}
def get_root_from_url(url):
    p = urlparse(url)
    return urlunparse([p.scheme, p.netloc, '', '', '', ''])



def make_no_root_entry_page_url_from_md5(md5, type='book'):
    # http://93.174.95.27/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40
    assert len(md5) == 32
    return r'/{}/index.php?md5={}'.format(type, md5)
def make_no_root_download_page_url_from_md5(md5):
    # http://93.174.95.27/ads.php?md5=8BDDD46CC786476D4B7A0DD942E20D40
    assert len(md5) == 32
    return r'/ads.php?md5={}'.format(md5)


def entry_page_url2curl_args__ex(entry_page_url, *, ext='', timeout=None):
    download_page_url = entry_page_url2download_page_url(entry_page_url)
    std_fname, download_url, torrent_url, md5, key = info =\
        fetch_info_from_download_page_url(download_page_url, timeout=timeout)
    std_fname += ext
    url = (download_url)
    return ['curl', '-C', '-', '-L', '--retry', '100', '--retry-delay', '16', '-o', std_fname, url], info
def entry_page_url2download_page_url(entry_page_url):
    md5 = get_one_md5_from_url(entry_page_url)
    no_root_download_page_url = make_no_root_download_page_url_from_md5(md5)
    root = get_root_from_url(entry_page_url)
    download_page_url = root + no_root_download_page_url
    return download_page_url

def test():
    entry_page_url = 'http://93.174.95.27/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40'
    download_page_url = "http://93.174.95.27/ads.php?md5=8BDDD46CC786476D4B7A0DD942E20D40"
    print(get_value_from_url(download_page_url))
    print(get_root_from_url(download_page_url))
    print(fetch_info__html(download_page))

    print(entry_page_url2curl_args__ex(entry_page_url))


def main(args=None):
    import argparse, subprocess, os, time, sys
    from .cmd_escape import escape_arguments_for_cmd_exe

    this_args = args if args is not None else sys.argv[1:]
    this_args = tuple(this_args)
    args = this_args


    parser = argparse.ArgumentParser(
            description='curl wrapper for Library Genesis'
            )
    parser.add_argument('entry_page_url', type=str,
                        help='e.g. http://libgen.io/book/index.php?md5=8BDDD46CC786476D4B7A0DD942E20D40')
    # parser.add_argument('curl_args', type=str, nargs = '*', default=[], help='args passed to curl')

    args, curl_args_more = parser.parse_known_args(args)
    entry_page_url = args.entry_page_url
    #curl_args_more = args.curl_args
    print(entry_page_url)


    ext = '.0' # downloading
    curl_args, info = entry_page_url2curl_args__ex(entry_page_url, timeout=60, ext=ext)
    std_fname = info[0]
    curl_args += curl_args_more
    downloading_fname = std_fname + ext


    curl_cmdline = escape_arguments_for_cmd_exe(curl_args)
    print(curl_args)
    print(curl_cmdline)
    with open('curl_args.records.u8', 'a', encoding='utf8') as fout:
        this_cmdline = escape_arguments_for_cmd_exe(this_args)
        print(curl_cmdline, file=fout)
        print(this_cmdline, file=fout)

    retry_if_return = [56, 18]
    time_gap_in_seconds = 16
    while True:
        return_code = subprocess.run(curl_args).returncode
        if return_code == 0: break
        if return_code not in retry_if_return:
            break
        time.sleep(time_gap_in_seconds)
    if return_code == 0:
        if os.path.exists(std_fname):
            raise Exception('download success but cannot rename to normal file name!')
        os.rename(downloading_fname, std_fname)
    parser.exit(return_code)

if __name__ == '__main__':
    main()



