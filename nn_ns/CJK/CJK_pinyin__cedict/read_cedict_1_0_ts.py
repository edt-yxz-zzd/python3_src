r'''[[[
e ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/read_cedict_1_0_ts.py


[[
view ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/read_cedict_1_0_ts.py
cedict_1_0_ts.u8
/\D:1
    搜索没有结果
    ==>> 没有 u:1 即 v1

带声调字母里面 有 u:1
    üǖǘǚǜ
        # ü 用在 虐nve
    view ../../python3_src/nn_ns/CJK/CJK_data/raw/拼音用字.py
    拼音用字囗带音调字母='=aāáǎà=AĀÁǍÀ=oōóǒò=OŌÓǑÒ=eēéěè=EĒÉĚÈ=iīíǐì=IĪÍǏÌ=uūúǔù=UŪÚǓÙ=üǖǘǚǜ=ÜǕǗǙǛ=nńňǹ=NŃŇǸ=mḿ=MḾ=gḡǵǧ=GḠǴǦ='
]]
[[
bug: not『v/ü』but『u:』
===
女 女 [nu:3] /female/woman/daughter/
女 女 [ru3] /archaic variant of 汝[ru3]/
女主人 女主人 [nu:3 zhu3 ren2] /hostess/mistress/
]]
[[
专有名词==>>拼音首字母大写
upper A-Z for name, e.g. surname/姓
===
吏部 吏部 [Li4 bu4] /Ministry of Appointments (in imperial China)/
羿 羿 [Yi4] /surname Yi/name of legendary archer/also written 后羿[Hou4 Yi4]/
后 后 [Hou4] /surname Hou/
后 后 [hou4] /empress/queen/
后妃 后妃 [hou4 fei1] /imperial wives and concubines/
后羿 后羿 [Hou4 Yi4] /Houyi, mythological Chinese archer whose wife was Chang'e/
后里鄉 后里乡 [Hou4 li3 xiang1] /Houli township in Taichung county 臺中縣|台中县[Tai2 zhong1 xian4], Taiwan/
後 后 [hou4] /back/behind/rear/afterwards/after/later/
後世 后世 [hou4 shi4] /later generations/
後周 后周 [Hou4 Zhou1] /Later Zhou of the Five Dynasties (951-960), centered on Shandong and Hebei, with capital at Kaifeng 开封/
後壁鄉 后壁乡 [Hou4 bi4 xiang1] /Houbi township in Tainan county 台南縣|台南县[Tai2 nan2 xian4], Taiwan/
後漢 后汉 [Hou4 Han4] /Later Han or Eastern Han dynasty (25-220)/Later Han of the Five Dynasties (947-950)/
後漢書 后汉书 [Hou4 Han4 shu1] /History of Eastern Han (later Han), third of the 24 dynastic histories 二十四史[Er4 shi2 si4 Shi3], composed by Fan Ye 範曄|范晔[Fan4 Ye4] in 445 during Song of the Southern Dynasties 南朝宋[Nan2 chao2 Song4], 120 scrolls/
後藤 后藤 [Hou4 teng2] /Gotō (Japanese surname)/
後西遊記 后西游记 [Hou4 Xi1 you2 Ji4] /one of three Ming dynasty sequels to Journey to the West 西遊記|西游记/
後西遊記 后西游记 [Hou4 Xi1 you2 Ji4] /one of three Ming dynasty sequels to Journey to the West 西遊記|西游记/
]]
[[
无拼音
xx, xx5
===
々 々 [xx] /iteration mark (used to represent a duplicated character)/
丆 丆 [xx5] /one of the characters used in kwukyel (phonetic "myeon"), an ancient Korean writing system/
丷 丷 [xx5] /one of the characters used in kwukyel, an ancient Korean writing system/
]]
[[
儿化音
r5
===
兒 儿 [r5] /non-syllabic diminutive suffix/retroflex final/

児 児 [er2] /Japanese variant of 兒|儿[er2]/
兒 儿 [er2] /child/son/
兒 儿 [r5] /non-syllabic diminutive suffix/retroflex final/

A圈兒 A圈儿 [A quan1 r5] /at symbol, @/
一下兒 一下儿 [yi1 xia4 r5] /erhua variant of 一下[yi1 xia4]/
]]
[[
双音节汉字:单位
13个
===
兙 兙 shi2 ke4
兛 兛 qian1 ke4
兝 兝 fen1 ke4
兞 兞 hao2 ke4
兡 兡 bai3 ke4
兣 兣 li2 ke4
瓧 瓧 shi2 wa3
瓩 瓩 qian1 wa3
瓰 瓰 fen1 wa3
瓱 瓱 hao2 wa3
瓸 瓸 bai3 wa3
瓼 瓼 li3 wa3
粨 粨 bai3 mi3
===
^[兙兛兝兞兡兣瓧瓩瓰瓱瓸瓼粨]
===
兙 兙 [shi2 ke4] /decagram (old)/single-character equivalent of 十克[shi2 ke4]/
兛 兛 [qian1 ke4] /kilogram (old)/single-character equivalent of 千克[qian1 ke4]/
兝 兝 [fen1 ke4] /decigram (old)/single-character equivalent of 分克[fen1 ke4]/
兞 兞 [hao2 ke4] /milligram (old)/single-character equivalent of 毫克[hao2 ke4]/
兡 兡 [bai3 ke4] /hectogram (old)/single-character equivalent of 百克[bai3 ke4]/
兣 兣 [li2 ke4] /centigram (old)/single-character equivalent of 厘克[li2 ke4]/
瓧 瓧 [shi2 wa3] /deciwatt (old)/single-character equivalent of 十瓦[shi2 wa3]/
瓩 瓩 [qian1 wa3] /kilowatt (old)/single-character equivalent of 千瓦[qian1 wa3]/
瓰 瓰 [fen1 wa3] /deciwatt (old)/single-character equivalent of 分瓦[fen1 wa3]/
瓱 瓱 [hao2 wa3] /milliwatt (old)/single-character equivalent of 毫瓦[hao2 wa3]/
瓸 瓸 [bai3 wa3] /hectowatt (old)/single-character equivalent of 百瓦/
瓼 瓼 [li3 wa3] /centiwatt (old)/
粨 粨 [bai3 mi3] /hectometer (old)/single-character equivalent of 百米/

===
]]
[[
□ □ ging1
兒 儿 r5  #『5』表示不标声调
忒 忒 tei1
覅 覅 fiao4
===
X光 X光 [X guang1] /X-ray/
□ □ [ging1] /uptight/obstinate/to awkwardly force oneself to do sth/(Taiwanese, POJ pr. [gēng], often written as ㄍㄧㄥ, no generally accepted hanzi form)/
○ ○ [ling2] /character used in Taiwan as a substitute for a real name (like "X" in English)/variant of 〇[ling2]/
⺮ ⺮ [zhu2] /"bamboo" radical in Chinese characters (Kangxi radical 118)/

兒 儿 [r5] /non-syllabic diminutive suffix/retroflex final/
忒 忒 [te4] /to err/to change/
忒 忒 [tei1] /(dialect) too/very/also pr. [tui1]/
覅 覅 [fiao4] /(fanqie contraction of 勿 and 要)/
===查字典:
忒: tei1,tui1,te4
覅: fiao4
儿:er2,r,ni2
儿2（兒）
[ér]后缀（注音作r）。
‘兒’另见Ní。

]]


view ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py

[[
!mv ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.u8.txt ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.u8.txt.bug
py -m nn_ns.CJK.CJK_pinyin__cedict.read_cedict_1_0_ts -i '/sdcard/0my_files/unzip/e_book/字词典/[Chinese-English dictionary]cedict_1_0_ts.u8'  -o ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.u8.txt
!rm  ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.u8.txt ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.u8.txt.bug
py -m nn_ns.CJK.CJK_pinyin__cedict.read_cedict_1_0_ts -i '/sdcard/0my_files/unzip/e_book/字词典/[Chinese-English dictionary]cedict_1_0_ts.u8'  -o ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py --use_version=2
py -m nn_ns.CJK.CJK_pinyin__cedict.hanzi2pinyins
    ok!
view ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py

py -m nn_ns.CJK.CJK_pinyin__cedict.read_cedict_1_0_ts -i '/sdcard/0my_files/unzip/e_book/字词典/[Chinese-English dictionary]cedict_1_0_ts.u8'  -o ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py --use_version=3
du -h ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py
    56K

py -m nn_ns.CJK.CJK_pinyin__cedict.read_cedict_1_0_ts -i '/sdcard/0my_files/unzip/e_book/字词典/[Chinese-English dictionary]cedict_1_0_ts.u8'  -o ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py --use_version=4
du -h ../../python3_src/nn_ns/CJK/CJK_pinyin__cedict/hanzi2pinyins.py
    64K


===:output of print_err()
□ □ ging1
々 々 xx
丆 丆 xx5
丷 丷 xx5
乊 乊 xx5
乤 乤 xx5
乥 乥 xx5
乧 乧 xx5
乫 乫 xx5
乷 乷 xx5
乺 乺 xx5
乼 乼 xx5
亪 亪 xx5
亽 亽 xx5
仒 仒 xx5
兒 儿 r5
兙 兙 shi2 ke4
兛 兛 qian1 ke4
兝 兝 fen1 ke4
兞 兞 hao2 ke4
兡 兡 bai3 ke4
兣 兣 li2 ke4
匁 匁 xx5
卪 卪 xx5
厼 厼 xx5
壭 壭 xx5
忒 忒 tei1
朩 朩 xx5
朰 朰 xx5
瓧 瓧 shi2 wa3
瓩 瓩 qian1 wa3
瓰 瓰 fen1 wa3
瓱 瓱 hao2 wa3
瓸 瓸 bai3 wa3
瓼 瓼 li3 wa3
畓 畓 xx5
粨 粨 bai3 mi3
罖 罖 xx5
覅 覅 fiao4
込 込 xx5
龶 龶 xx5
===>:
□ □ ging1
兒 儿 r5
忒 忒 tei1
覅 覅 fiao4
===>:
++new:normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair____ucdXcedict
    #fixed for: tei1,fiao4,ging1
    #   not for 『r5』
]]



#]]]'''


__all__ = r'''
read_cedict_1_0_ts
main
'''.split()#'''


import re
from collections import defaultdict


from nn_ns.CJK.CJK_common.save_load_hanzi2pinyins import save8py_src
from seed.iters.iter_unique_by_hash import remove_duplicates_by_hash
from seed.tiny import fmap4dict_value
#from seed.io.savefile.SaveFile import create_or_extend_SaveFile__ObjectPerLine
from ..CJK_data.normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair import (
    normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair
    )
from ..CJK_data.normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair import (
    normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair____ucdXcedict
    as normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair
        #fixed for: tei1,fiao4,ging1
        #   not for 『r5』
    )
from ..CJK_common.normal_pinyin_prime2full_pinyin_prime import (
    normal_pinyin2full_pinyin_pair
    ,split_normal_pinyin
    )
from seed.tiny import print_err

class Global:
    kwargs = {'hanzi_only':True, 'pinyin_only':True, 'generator':__file__}
    iencoding = 'u8'
    oencoding = 'u8'
    ipath_to_cedict_1_0_ts = r'E:\book\数据\[Chinese-English dictionary]cedict_1_0_ts.u8'
    ipath_to_cedict_1_0_ts = r'/sdcard/0my_files/unzip/e_book/字词典/[Chinese-English dictionary]cedict_1_0_ts.u8'
    #opath_to_hanzi2pinyins = fr'hanzi2pinyins.{oencoding}.txt'
    opath_to_hanzi2pinyins = fr'hanzi2pinyins.py'
    #######################
    zh_char_pattern = r'[^\x00-\xFF]'
    #bug:[no "v" but "u:"]:zh_char_line_start_rex = re.compile(fr'^\s*(?P<traditional>{zh_char_pattern})\s+(?P<simpilfied>{zh_char_pattern})\s+\[(?P<pinyin>[a-z]+\d)\]')
    zh_char_line_start_rex = re.compile(fr'^\s*(?P<traditional>{zh_char_pattern})\s+(?P<simpilfied>{zh_char_pattern})\s+\[(?P<pinyin>[^\]]*)\]')
        #regex直接跳过词语，只读单字
        #   not merge pinyin_rex, to detect bug
    pinyin_rex = re.compile(r'[a-uw-z:]+\d', re.IGNORECASE)
    pinyin_using_v_rex = re.compile(r'[a-z]+\d', re.IGNORECASE)

def read_cedict_1_0_ts(ifile):
    'regex直接跳过词语，只读单字'
    hanzi2pinyins = defaultdict(list)
    regex = Global.zh_char_line_start_rex
    pinyin_rex = Global.pinyin_rex
    pinyin_using_v_rex = Global.pinyin_using_v_rex

    if 0b0 and __debug__:
        ifile = ['覅 覅 [fiao4] /(fanqie contraction of 勿 and 要)/']
    for line in ifile:
        m = regex.match(line)
        if m:
            chT = m['traditional']
            chS = m['simpilfied']
            original_pinyin = m['pinyin']
            pinyin = original_pinyin.lower()
            pinyin_using_v = pinyin.replace('u:', 'v')
            try:
                assert pinyin_rex.fullmatch(pinyin)
                assert pinyin_using_v_rex.fullmatch(pinyin_using_v)
                (normal_pinyin_prime, _) = split_normal_pinyin(pinyin)
                normal_pinyin_prime2full_pinyin_prime_ym_cls_ex_pair[normal_pinyin_prime]
            except Exception:
                #if pinyin == 'fiao4':raise
                assert pinyin in 'xx,xx5,r5' or ' ' in pinyin
                print_err(chT, chS, original_pinyin)
            else:
                hanzi2pinyins[chT].append(pinyin_using_v)
                hanzi2pinyins[chS].append(pinyin_using_v)
    #return dict(hanzi2pinyins)
    hanzi2pinyins = fmap4dict_value(remove_duplicates_by_hash, hanzi2pinyins)
    return hanzi2pinyins

def _pack(hanzi2pinyins):
    hanzi2pinyins_str = fmap4dict_value(','.join, hanzi2pinyins)
    txt = '\n'.join(f'{hz}:{s}' for hz,s in sorted(hanzi2pinyins_str.items()))
    assert _parse(txt) == hanzi2pinyins
    return txt

_src4parse = r'''
def _parse(txt):
    return dict(_parse__iter(txt))
def _parse__iter(txt):
    #txt = txt.strip()
    ss = txt.split()
    for hz_s in ss:
        [hz],s = hz_s.split(':')
        pinyins = s.split(',')
        yield hz, tuple(pinyins)
'''#'''
exec(_src4parse)

_fmt4out = f"""\
#hanzi2pinyins generated by {{this_file_name}}

{_src4parse}

hanzi2pinyins = _parse(r'''
{{txt}}
''')#'''

"""#"""

def main(args=None):
    import argparse
    from seed.io.may_open import may_open_stdout # may_open_stdin
    from pprint import pprint
    from pathlib import PurePath as Path
    this_file = Path(__file__)
    this_folder = this_file.parent
    this_file_name = this_file.name




    parser = argparse.ArgumentParser(
        description=f'read “{Global.ipath_to_cedict_1_0_ts}”'
        , epilog=''
        , formatter_class=argparse.RawDescriptionHelpFormatter
        )

    parser.add_argument('--use_version', type=int, default=4, choices=[1,2,3,4]
                        , help='select impl version')

    parser.add_argument('-i', '--input', type=str, default=None
                        , help='input file path')
    parser.add_argument('-o', '--output', type=str, default=None
                        , help='output file path')
    parser.add_argument('-ie', '--input_encoding', type=str
                        , default=Global.iencoding
                        , help='input file encoding')
    parser.add_argument('-oe', '--output_encoding', type=str
                        , default=Global.oencoding
                        , help='output file encoding')
    parser.add_argument('-f', '--force', action='store_true'
                        , default = False
                        , help='open mode for output file')

    args = parser.parse_args(args)
    version = args.use_version
    input_encoding = args.input_encoding
    output_encoding = args.output_encoding
    omode = 'w+t' if args.force else 'x+t'

    may_ifname = args.input
    if may_ifname is None:
        ifname = this_folder / Global.ipath_to_cedict_1_0_ts
    else:
        ifname = may_ifname
    with open(ifname, 'rt', encoding=input_encoding) as ifile:
        hanzi2pinyins = read_cedict_1_0_ts(ifile)
    if version in [3, 4]:
        partition_by_single_pinyin = version==4
        whole_txt = save8py_src(hanzi2pinyins, nm4varable4hanzi2pinyins='hanzi2pinyins', nm4data_mkr=this_file_name, partition_by_single_pinyin=partition_by_single_pinyin)
    elif version == 2:
        txt = _pack(hanzi2pinyins)
        whole_txt = _fmt4out.format(this_file_name=this_file_name, txt=txt)

    may_ofname = args.output
    if may_ofname is None:
        may_ofname = this_folder / Global.opath_to_hanzi2pinyins
    '''
    kwargs = Global.kwargs
    with open(opath, omode, encoding=oencoding) as ofile:
        create_or_extend_SaveFile__ObjectPerLine(ofile, hanzi2pinyins.items(), encoding=oencoding, kwargs=kwargs)
    '''
    with may_open_stdout(may_ofname, omode, encoding=output_encoding) as fout:
        if version in [2,3,4]:
            print(whole_txt, file=fout)
        else:
            print(f'#hanzi2pinyins generated by {this_file_name}', file=fout);
            print('hanzi2pinyins = \\', file=fout);
            pprint(hanzi2pinyins, stream=fout)


from nn_ns.CJK.CJK_pinyin__cedict.read_cedict_1_0_ts  import *
if __name__ == '__main__':
    main()

